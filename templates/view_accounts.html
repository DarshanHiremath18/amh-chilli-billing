{% extends "base.html" %}
{% block content %}

<form method="GET" class="mb-3">
  <input
  type="text"
  id="searchInput"
  class="form-control mb-3"
  placeholder="Search by name, mobile or city">

</form>

<div class="container-fluid px-4 content-container">
  <h2 class="text-success fw-bold mb-4">
    {{ account_type }} List
  </h2>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} text-center">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  {% if accounts %}
  <div class="table-responsive">
    <table class="table table-bordered table-hover align-middle text-center">
      <thead>
        <tr>
          <th>#</th>
          <th>First Name</th>
          <th>Middle Name</th>
          <th>Last Name</th>
          <th>Aadhaar</th>
          <th>PAN</th>
          {% if account_type == 'Purchaser' %}
          <th>GST</th>
          <th>Company Name</th>
          <th>Short Name</th>
          {% endif %}
          <th>Account Name</th>
          <th>Account Number</th>
          <th>Bank</th>
          <th>IFSC</th>
          <th>District</th>
          <th>City</th>
          <th>Mobile</th>
          <th>Email</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for account in accounts %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ account.first_name }}</td>
          <td>{{ account.middle_name or 'N/A' }}</td>
          <td>{{ account.last_name or 'N/A' }}</td>
          <td>{{ account.adhar }}</td>
          <td>{{ account.pan or 'N/A' }}</td>
          {% if account_type == 'Purchaser' %}
          <td>{{ account.gst or 'N/A' }}</td>
          <td>{{ account.company_name or 'N/A' }}</td>
          <td>{{ account.short_name or 'N/A' }}</td>
          {% endif %}
          <td>{{ account.account_name }}</td>
          <td>{{ account.account_number }}</td>
          <td>{{ account.bank_name or 'N/A' }}</td>
          <td>{{ account.ifsc_code or 'N/A' }}</td>
          <td>{{ account.district or 'N/A' }}</td>
          <td>{{ account.city or 'N/A' }}</td>
          <td>{{ account.mobile }}</td>
          <td>{{ account.email or 'N/A' }}</td>
          <td class="d-flex flex-column gap-2">
            <a href="{{ url_for('add_account', account_id=account.account_id) }}" class="btn btn-sm btn-edit" title="Edit">
              <i class="fa-solid fa-pencil"></i> Edit
            </a>
            <a href="{{ url_for('delete_account', account_id=account.account_id) }}" 
               class="btn btn-sm btn-delete" title="Delete"
               onclick="return confirm('Are you sure you want to delete this {{ account_type }}?');">
               <i class="fa-solid fa-trash"></i> Delete
            </a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="alert alert-info text-center">No {{ account_type.lower() }}s added yet.</div>
  {% endif %}
</div>

<script>
const searchInput = document.getElementById("searchInput");
let debounceTimer = null;

searchInput.addEventListener("keyup", function () {
  clearTimeout(debounceTimer);

  const query = searchInput.value.trim();

  debounceTimer = setTimeout(() => {
    fetchResults(query);
  }, 300); // wait 300ms after typing stops
});

function fetchResults(query) {
  fetch(`/accounts/search/Farmer?q=${encodeURIComponent(query)}`)
    .then(res => res.json())
    .then(data => updateTable(data));
}

function updateTable(accounts) {
  const tbody = document.querySelector("table tbody");
  tbody.innerHTML = "";

  if (!accounts.length) {
    tbody.innerHTML = `
      <tr>
        <td colspan="15" class="text-center">No results found</td>
      </tr>`;
    return;
  }

  accounts.forEach((acc, index) => {
    const row = `
      <tr>
        <td>${index + 1}</td>
        <td>${acc.first_name || ""}</td>
        <td>${acc.middle_name || ""}</td>
        <td>${acc.last_name || ""}</td>
        <td>${acc.adhar || ""}</td>
        <td>${acc.pan || ""}</td>
        <td>${acc.account_name || ""}</td>
        <td>${acc.account_number || ""}</td>
        <td>${acc.bank_name || ""}</td>
        <td>${acc.ifsc_code || ""}</td>
        <td>${acc.district || ""}</td>
        <td>${acc.city || ""}</td>
        <td>${acc.mobile || ""}</td>
        <td>${acc.email || ""}</td>
        <td>
          <a href="/accounts/edit/${acc.account_id}"
             class="btn btn-sm btn-primary">Edit</a>
        </td>
      </tr>
    `;
    tbody.insertAdjacentHTML("beforeend", row);
  });
}
</script>




<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  body {
    background-color: #f8f9fa;
  }

  .content-container {
    margin-top: 100px; /* adjust based on navbar */
    background: white;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    width: 95%;
  }

  .table th {
    background-color: #198754;
    color: white;
  }

  .btn-edit {
    background-color: #0d6efd;
    color: white;
  }

  .btn-delete {
    background-color: #dc3545;
    color: white;
  }

  .btn-edit:hover, .btn-delete:hover {
    opacity: 0.9;
  }

  @media (max-width: 768px) {
    .table {
      font-size: 12px;
    }
  }
</style>
{% endblock %}
